name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      swift: ${{ github.event_name == 'push' || steps.filter.outputs.swift }}
      rust: ${{ github.event_name == 'push' || steps.filter.outputs.rust }}
      sample-app: ${{ github.event_name == 'push' || steps.filter.outputs.sample-app }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            swift:
              - 'macOS/**'
              - 'Package.swift'
              - 'Package.resolved'
            rust:
              - 'windows/**'
            sample-app:
              - 'Examples/windows/SampleApp/**'
              - '!Examples/windows/SampleApp/src-tauri/**'

  swift-lint:
    name: Swift Lint
    needs: changes
    if: needs.changes.outputs.swift == 'true'
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Install SwiftLint
        run: |
          SWIFTLINT_VERSION=0.57.1
          curl -sL "https://github.com/realm/SwiftLint/releases/download/${SWIFTLINT_VERSION}/portable_swiftlint.zip" -o swiftlint.zip
          unzip -q swiftlint.zip -d swiftlint
          echo "$PWD/swiftlint" >> "$GITHUB_PATH"

      - name: Install SwiftFormat
        run: |
          SWIFTFORMAT_VERSION=0.55.5
          curl -sL "https://github.com/nicklockwood/SwiftFormat/releases/download/${SWIFTFORMAT_VERSION}/swiftformat.zip" -o swiftformat.zip
          unzip -q swiftformat.zip
          chmod +x swiftformat
          echo "$PWD" >> "$GITHUB_PATH"

      - name: SwiftLint
        run: swiftlint lint --strict --config macOS/.swiftlint.yml macOS/Sources/ macOS/Tests/

      - name: SwiftFormat
        run: swiftformat --lint --config macOS/.swiftformat macOS/Sources/ macOS/Tests/

  swift-test:
    name: Swift Build & Test
    needs: changes
    if: needs.changes.outputs.swift == 'true'
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Build
        run: swift build

      - name: Test
        run: swift test

  rust-lint:
    name: Rust Lint (Linux)
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "windows -> windows/target"

      - name: Check formatting
        run: cargo fmt --check --manifest-path windows/Cargo.toml

      - name: Clippy (core â€” platform-agnostic)
        run: >
          cargo clippy --manifest-path windows/Cargo.toml
          -p audio-capture-core
          -- -D warnings -W clippy::undocumented_unsafe_blocks

  rust-clippy-windows:
    name: Rust Clippy (Windows)
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "windows -> windows/target"

      - name: Clippy (windows crate)
        run: >
          cargo clippy --manifest-path windows/Cargo.toml
          -p audio-capture-windows
          -- -D warnings -W clippy::undocumented_unsafe_blocks

  rust-test:
    name: Rust Test (${{ matrix.package }})
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - package: audio-capture-core
            os: ubuntu-latest
          - package: audio-capture-windows
            os: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "windows -> windows/target"

      - name: Test
        run: cargo test --manifest-path windows/Cargo.toml -p ${{ matrix.package }}

  sample-app-lint:
    name: Sample App Lint
    needs: changes
    if: needs.changes.outputs.sample-app == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Examples/windows/SampleApp
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: Examples/windows/SampleApp/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit

      - name: npm audit
        run: npm audit --audit-level=high

  dependency-review:
    name: Dependency Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-2.0, GPL-3.0, AGPL-3.0
