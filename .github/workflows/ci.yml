name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      swift: ${{ github.event_name == 'push' || steps.filter.outputs.swift }}
      rust: ${{ github.event_name == 'push' || steps.filter.outputs.rust }}
      sample-app: ${{ github.event_name == 'push' || steps.filter.outputs.sample-app }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          filters: |
            swift:
              - 'macOS/**'
              - 'Package.swift'
              - 'Package.resolved'
            rust:
              - 'windows/**'
              - 'Examples/windows/SampleApp/src-tauri/**'
            sample-app:
              - 'Examples/windows/SampleApp/**'
              - '!Examples/windows/SampleApp/src-tauri/**'

  swift-lint:
    name: Swift Lint
    needs: changes
    if: needs.changes.outputs.swift == 'true'
    runs-on: macos-15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install SwiftLint
        run: |
          SWIFTLINT_VERSION=0.57.1
          curl -sL "https://github.com/realm/SwiftLint/releases/download/${SWIFTLINT_VERSION}/portable_swiftlint.zip" -o swiftlint.zip
          unzip -q swiftlint.zip -d swiftlint
          echo "$PWD/swiftlint" >> "$GITHUB_PATH"

      - name: Install SwiftFormat
        run: |
          SWIFTFORMAT_VERSION=0.55.5
          curl -sL "https://github.com/nicklockwood/SwiftFormat/releases/download/${SWIFTFORMAT_VERSION}/swiftformat.zip" -o swiftformat.zip
          unzip -q swiftformat.zip
          chmod +x swiftformat
          echo "$PWD" >> "$GITHUB_PATH"

      - name: SwiftLint
        run: swiftlint lint --strict --config macOS/.swiftlint.yml macOS/Sources/ macOS/Tests/

      - name: SwiftFormat
        run: swiftformat --lint --config macOS/.swiftformat macOS/Sources/ macOS/Tests/

  swift-test:
    name: Swift Build & Test
    needs: changes
    if: needs.changes.outputs.swift == 'true'
    runs-on: macos-15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Cache SPM dependencies
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ runner.os }}-${{ hashFiles('Package.resolved') }}
          restore-keys: spm-${{ runner.os }}-

      - name: Build
        run: swift build

      - name: Test
        run: swift test

  rust-lint:
    name: Rust Lint (Linux)
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          workspaces: "windows -> windows/target"

      - name: Check formatting
        working-directory: windows
        run: cargo fmt --all --check

      - name: Clippy (core â€” platform-agnostic)
        run: >
          cargo clippy --manifest-path windows/Cargo.toml
          -p audio-capture-core
          -- -D warnings -W clippy::undocumented_unsafe_blocks

  rust-clippy-windows:
    name: Rust Clippy (Windows)
    needs: changes
    if: needs.changes.outputs.rust == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          workspaces: "windows -> windows/target"

      - name: Clippy (windows crate)
        run: >
          cargo clippy --manifest-path windows/Cargo.toml
          -p audio-capture-windows
          -- -D warnings

  rust-test:
    name: Rust Test (${{ matrix.package }})
    needs: changes
    # No job-level if: matrix jobs must always run so each expanded name
    # (e.g. "Rust Test (audio-capture-core)") is individually reported to
    # GitHub. A job-level if causes GitHub to report only the unexpanded
    # template name, which never satisfies the required status checks.
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - package: audio-capture-core
            os: ubuntu-latest
          - package: audio-capture-windows
            os: windows-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: dtolnay/rust-toolchain@stable
        if: needs.changes.outputs.rust == 'true'

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        if: needs.changes.outputs.rust == 'true'
        with:
          workspaces: "windows -> windows/target"

      - name: Test
        if: needs.changes.outputs.rust == 'true'
        run: cargo test --manifest-path windows/Cargo.toml -p ${{ matrix.package }}

  sample-app-lint:
    name: Sample App Lint
    needs: changes
    if: needs.changes.outputs.sample-app == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Examples/windows/SampleApp
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: Examples/windows/SampleApp/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit

      - name: npm audit
        run: npm audit --audit-level=high

  dependency-review:
    name: Dependency Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - uses: actions/dependency-review-action@05fe4576374b728f0c523d6a13d64c25081e0803 # v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-2.0, GPL-3.0, AGPL-3.0
